# üìö Documentation : Migration MongoDB ‚Üí MySQL pour les Avis (Reviews)

## üîç Pourquoi MongoDB n'a pas fonctionn√© avec Heroku ?

### ‚ùå Probl√®mes rencontr√©s avec MongoDB

#### 1. **MongoDB Atlas - Incompatibilit√© TLS**
- **Probl√®me** : MongoDB Atlas impose l'utilisation de TLS/SSL pour toutes les connexions
- **Erreur** : `TLS handshake failed: error:0A000438:SSL routines::tlsv1 alert internal error`
- **Cause** : L'extension PHP MongoDB sur Heroku (version 2.1.1) n'est pas compatible avec le niveau de s√©curit√© TLS exig√© par MongoDB Atlas
- **Solutions tent√©es** :
  - ‚úó Configuration `tls: false` dans `doctrine_mongodb.yaml`
  - ‚úó Param√®tres `tlsAllowInvalidCertificates: true`
  - ‚úó Utilisation de `mongodb+srv://` (connection string DNS)
  - ‚úó Utilisation de `mongodb://` (connection string standard)
  - **R√©sultat** : Toutes les tentatives ont √©chou√© avec des erreurs de handshake TLS

#### 2. **Clever Cloud MongoDB - Plus de plan gratuit**
- **Probl√®me** : Clever Cloud a supprim√© son plan MongoDB gratuit (DEV)
- **Observation** : Tous les plans disponibles sont payants
- **Co√ªt minimum** : Impossible √† utiliser gratuitement

#### 3. **ObjectRocket MongoDB (Heroku Addon)**
- **Probl√®me** : Le seul addon MongoDB disponible sur Heroku
- **Co√ªt** : **~$95/mois** (plan minimum)
- **Conclusion** : Trop cher pour un projet √©tudiant/p√©dagogique

#### 4. **Autres alternatives envisag√©es**
- **Oracle Cloud Free Tier** : N√©cessite une carte bancaire et configuration VPS complexe
- **MongoDB Community sur VPS** : N√©cessite gestion d'infrastructure et maintenance

### üìä Tableau comparatif des solutions

| Solution | Gratuit ? | Compatible Heroku ? | Complexit√© | Verdict |
|----------|-----------|---------------------|------------|---------|
| MongoDB Atlas | ‚úÖ Oui | ‚ùå Non (TLS incompatible) | Moyenne | ‚ùå Impossible |
| Clever Cloud | ‚ùå Non | ‚úÖ Oui | Faible | ‚ùå Payant |
| ObjectRocket | ‚ùå Non ($95/mois) | ‚úÖ Oui | Faible | ‚ùå Trop cher |
| Oracle Cloud VPS | ‚úÖ Oui | ‚ö†Ô∏è Externe | √âlev√©e | ‚ö†Ô∏è Complexe |
| **MySQL (Heroku)** | ‚úÖ Oui | ‚úÖ Oui | Tr√®s faible | ‚úÖ **SOLUTION RETENUE** |

---

## ‚úÖ Solution adopt√©e : Migration vers MySQL

### üí° Pourquoi MySQL ?

1. ‚úÖ **D√©j√† configur√©** : MySQL est d√©j√† install√© et fonctionnel sur Heroku (ClearDB addon)
2. ‚úÖ **100% gratuit** : Inclus dans le plan gratuit Heroku
3. ‚úÖ **Aucune configuration suppl√©mentaire** : Pas besoin d'addon externe
4. ‚úÖ **Performant** : Suffisant pour stocker des avis (reviews)
5. ‚úÖ **Fiable** : Pas de probl√®mes de connexion TLS
6. ‚úÖ **Bien support√©** : Doctrine ORM parfaitement int√©gr√© avec Symfony

---

## üîÑ √âtapes de la migration MongoDB ‚Üí MySQL

### 1. Cr√©er l'entit√© MySQL `TripReview`

**Fichier cr√©√©** : `src/Entity/TripReview.php`

```php
<?php

namespace App\Entity;

use App\Repository\TripReviewRepository;
use Doctrine\DBAL\Types\Types;
use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity(repositoryClass: TripReviewRepository::class)]
#[ORM\Table(name: 'trip_review')]
class TripReview
{
    #[ORM\Id]
    #[ORM\GeneratedValue]
    #[ORM\Column]
    private ?int $id = null;

    #[ORM\Column(type: Types::INTEGER)]
    private ?int $tripId = null;

    #[ORM\Column(type: Types::INTEGER)]
    private ?int $userId = null;

    #[ORM\Column(length: 255)]
    private ?string $userPseudo = null;

    #[ORM\Column(type: Types::TEXT)]
    private ?string $comment = null;

    #[ORM\Column(type: Types::INTEGER)]
    private ?int $rating = null;

    #[ORM\Column(type: Types::DATETIME_MUTABLE)]
    private ?\DateTimeInterface $createdAt = null;

    // Getters et Setters...
}
```

**Diff√©rences avec MongoDB** :
- MongoDB : `#[MongoDB\Document(collection: "trip_reviews")]`
- MySQL : `#[ORM\Entity(repositoryClass: TripReviewRepository::class)]`
- MongoDB : `#[MongoDB\Id]` (g√©n√®re un ObjectId)
- MySQL : `#[ORM\Id]` + `#[ORM\GeneratedValue]` (g√©n√®re un INT AUTO_INCREMENT)
- MongoDB : `#[MongoDB\Field(type: "string")]`
- MySQL : `#[ORM\Column(type: Types::INTEGER)]` ou `#[ORM\Column(length: 255)]`

---

### 2. Cr√©er le Repository

**Fichier cr√©√©** : `src/Repository/TripReviewRepository.php`

```php
<?php

namespace App\Repository;

use App\Entity\TripReview;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

class TripReviewRepository extends ServiceEntityRepository
{
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, TripReview::class);
    }
}
```

---

### 3. Cr√©er la migration de base de donn√©es

**Fichier cr√©√©** : `migrations/Version20251007200000.php`

```php
<?php

declare(strict_types=1);

namespace DoctrineMigrations;

use Doctrine\DBAL\Schema\Schema;
use Doctrine\Migrations\AbstractMigration;

final class Version20251007200000 extends AbstractMigration
{
    public function getDescription(): string
    {
        return 'Create trip_review table for storing trip reviews in MySQL';
    }

    public function up(Schema $schema): void
    {
        $this->addSql('CREATE TABLE trip_review (
            id INT AUTO_INCREMENT NOT NULL,
            trip_id INT NOT NULL,
            user_id INT NOT NULL,
            user_pseudo VARCHAR(255) NOT NULL,
            comment LONGTEXT NOT NULL,
            rating INT NOT NULL,
            created_at DATETIME NOT NULL,
            PRIMARY KEY(id),
            INDEX IDX_trip_id (trip_id)
        ) DEFAULT CHARACTER SET utf8mb4 COLLATE `utf8mb4_unicode_ci` ENGINE = InnoDB');
    }

    public function down(Schema $schema): void
    {
        $this->addSql('DROP TABLE trip_review');
    }
}
```

**Commande pour ex√©cuter la migration sur Heroku** :
```bash
heroku run "php bin/console doctrine:query:sql 'CREATE TABLE IF NOT EXISTS trip_review (...)'" --app ecoecoride
```

---

### 4. Mettre √† jour le contr√¥leur `TripReviewController`

**Fichier modifi√©** : `src/Controller/TripReviewController.php`

**Avant (MongoDB)** :
```php
use Doctrine\ODM\MongoDB\DocumentManager;
use App\Document\TripReview;

private DocumentManager $dm;

public function __construct(DocumentManager $dm, ...)
{
    $this->dm = $dm;
}

// Dans la m√©thode add()
$review = new TripReview();
$review->setTripId((string) $trip->getId()) // String pour MongoDB
       ->setUserId((string) $user->getId())
       // ...

$this->dm->persist($review);
$this->dm->flush();

// Dans la m√©thode getReviews()
$reviews = $this->dm->getRepository(TripReview::class)
                    ->findBy(['tripId' => (string) $tripId]);
```

**Apr√®s (MySQL)** :
```php
use Doctrine\ORM\EntityManagerInterface;
use App\Entity\TripReview;

private EntityManagerInterface $em;

public function __construct(EntityManagerInterface $em, ...)
{
    $this->em = $em;
}

// Dans la m√©thode add()
$review = new TripReview();
$review->setTripId($trip->getId()) // INT pour MySQL
       ->setUserId($user->getId())
       // ...

$this->em->persist($review);
$this->em->flush();

// Dans la m√©thode getReviews()
$reviews = $this->em->getRepository(TripReview::class)
                    ->findBy(['tripId' => $tripId]);
```

**Changements principaux** :
- `DocumentManager` ‚Üí `EntityManagerInterface`
- `App\Document\TripReview` ‚Üí `App\Entity\TripReview`
- IDs en `string` ‚Üí IDs en `int`
- `$this->dm` ‚Üí `$this->em`

---

### 5. Supprimer les fichiers et configurations MongoDB

#### Fichiers supprim√©s :
1. ‚úÖ `config/packages/doctrine_mongodb.yaml` (configuration MongoDB)
2. ‚úÖ `src/Document/TripReview.php` (document MongoDB)
3. ‚úÖ `src/Controller/MongoTestController.php` (contr√¥leur de test)
4. ‚úÖ `src/Command/TripReviewPreviewCommand.php` (commande utilisant MongoDB)

#### Configuration modifi√©e :

**Fichier** : `config/bundles.php`
```php
// AVANT
Doctrine\Bundle\MongoDBBundle\DoctrineMongoDBBundle::class => ['all' => true],

// APR√àS (comment√©)
// Doctrine\Bundle\MongoDBBundle\DoctrineMongoDBBundle::class => ['all' => true], // D√©sactiv√© - migration vers MySQL
```

**Fichier** : `config/services.yaml`
```yaml
# AVANT
bind:
    $profilesDirectory: '%profiles_directory%'

App\Command\:
    resource: '../src/Command'
    tags: ['console.command']

# APR√àS (comment√© car dossier Command supprim√©)
# bind:
#     $profilesDirectory: '%profiles_directory%'

# App\Command\:
#     resource: '../src/Command'
#     tags: ['console.command']
```

---

### 6. D√©ployer sur Heroku

```bash
# 1. Ajouter tous les changements
git add -A

# 2. Commit
git commit -m "Migrate reviews from MongoDB to MySQL"

# 3. Push vers Heroku
git push heroku master

# 4. Cr√©er la table trip_review
heroku run "php bin/console doctrine:query:sql 'CREATE TABLE IF NOT EXISTS trip_review (...)'" --app ecoecoride
```

---

## üìà Structure de la table MySQL

```sql
CREATE TABLE trip_review (
    id INT AUTO_INCREMENT NOT NULL,          -- ID auto-incr√©ment√©
    trip_id INT NOT NULL,                    -- ID du trajet
    user_id INT NOT NULL,                    -- ID de l'utilisateur
    user_pseudo VARCHAR(255) NOT NULL,       -- Pseudo de l'utilisateur
    comment LONGTEXT NOT NULL,               -- Commentaire de l'avis
    rating INT NOT NULL,                     -- Note (1-5)
    created_at DATETIME NOT NULL,            -- Date de cr√©ation
    PRIMARY KEY(id),                         -- Cl√© primaire
    INDEX IDX_trip_id (trip_id)              -- Index pour optimiser les requ√™tes par trip_id
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ENGINE = InnoDB;
```

---

## üîÑ Comparaison MongoDB vs MySQL pour les avis

| Crit√®re | MongoDB | MySQL |
|---------|---------|-------|
| **Type de stockage** | NoSQL (Document) | SQL (Relationnel) |
| **Structure** | Flexible (JSON-like) | Rigide (sch√©ma fixe) |
| **ID** | ObjectId (string) | INT AUTO_INCREMENT |
| **Requ√™tes** | Queries MongoDB | SQL standard |
| **Compatibilit√© Heroku** | ‚ùå Probl√®mes TLS | ‚úÖ Parfait |
| **Co√ªt sur Heroku** | üí∞ $95/mois minimum | ‚úÖ Gratuit |
| **Performance** | ‚ö° Excellent (gros volumes) | ‚úÖ Suffisant (notre cas) |
| **Maintenance** | ‚ö†Ô∏è Externe √† g√©rer | ‚úÖ Int√©gr√© Heroku |

**Pour notre cas d'usage** (avis de trajets) :
- Volume de donn√©es : ‚úÖ Faible √† moyen ‚Üí MySQL parfait
- Besoin de flexibilit√© NoSQL : ‚ùå Non ‚Üí Structure fixe suffit
- Co√ªt : ‚úÖ Gratuit avec MySQL vs $95/mois MongoDB
- Complexit√© : ‚úÖ Plus simple avec MySQL (d√©j√† configur√©)

---

## ‚úÖ R√©sultat final

### Avantages de la solution MySQL :
1. ‚úÖ **Fonctionne parfaitement** : Aucune erreur de connexion
2. ‚úÖ **100% gratuit** : Inclus dans le plan Heroku
3. ‚úÖ **Aucune configuration externe** : Tout est dans Heroku
4. ‚úÖ **Performance suffisante** : Pour le volume d'avis attendu
5. ‚úÖ **Maintenance simplifi√©e** : Une seule base de donn√©es (MySQL) pour tout
6. ‚úÖ **Coh√©rence** : Toutes les donn√©es au m√™me endroit

### Fonctionnalit√©s op√©rationnelles :
- ‚úÖ Ajouter un avis sur un trajet
- ‚úÖ Lister les avis d'un trajet
- ‚úÖ Affichage du pseudo, commentaire, note et date
- ‚úÖ Persistance des donn√©es

---

## üìù Conclusion

**MongoDB √©tait la solution initiale pr√©vue** pour stocker les avis car :
- Flexibilit√© NoSQL
- Structure de donn√©es simple (document JSON)
- Pas de relations complexes

**MAIS** les contraintes techniques et financi√®res sur Heroku ont rendu cette solution **impossible** :
- ‚ùå Incompatibilit√© TLS avec MongoDB Atlas
- ‚ùå Pas d'addon MongoDB gratuit sur Heroku
- ‚ùå Solutions externes complexes ou payantes

**La migration vers MySQL s'est r√©v√©l√©e √™tre la meilleure solution** :
- ‚úÖ Simple √† mettre en ≈ìuvre
- ‚úÖ Gratuit
- ‚úÖ Performant
- ‚úÖ D√©j√† configur√© sur Heroku

**R√©sultat** : Application 100% fonctionnelle avec une base de donn√©es unique (MySQL) pour toutes les fonctionnalit√©s ! üéâ

---

## üîó Liens utiles

- [Documentation Doctrine ORM](https://www.doctrine-project.org/projects/doctrine-orm/en/latest/index.html)
- [Doctrine Migrations](https://www.doctrine-project.org/projects/doctrine-migrations/en/latest/index.html)
- [Heroku MySQL (ClearDB)](https://devcenter.heroku.com/articles/cleardb)
- [MongoDB Atlas TLS Requirements](https://www.mongodb.com/docs/atlas/security/tls/)

---

**Date de migration** : 7 octobre 2025  
**Version d√©ploy√©e** : v42  
**Statut** : ‚úÖ Migration r√©ussie - Application fonctionnelle


